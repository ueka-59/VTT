<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VTT Ultimate V18.4 - PWA Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root { --dark: #000; --panel: #242b33; --blue: #3498db; --green: #27ae60; --red: #e74c3c; --orange: #f39c12; --purple: #9b59b6; --text: #ecf0f1; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--dark); color: var(--text); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #toolbar { height: 115px; background: var(--panel); display: flex; align-items: center; padding: 0 10px; gap: 8px; border-bottom: 3px solid var(--blue); z-index: 1000; overflow-x: auto; flex-shrink: 0; }
        .btn-group { display: flex; flex-direction: column; gap: 4px; justify-content: center; align-items: center; border-right: 1px solid #444; padding-right: 8px; height: 90%; flex-shrink: 0; }
        button { background: var(--blue); color: white; border: none; padding: 8px; border-radius: 6px; font-weight: bold; font-size: 10px; cursor: pointer; }
        button.active { background: var(--red) !important; box-shadow: 0 0 10px var(--red); }

        #game-container { flex: 1; position: relative; background: #000; overflow: hidden; touch-action: none; }
        #map-canvas { position: absolute; top:0; left:0; z-index: 1; }
        #token-layer { position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        #fog-canvas { position: absolute; top:0; left:0; z-index: 50; opacity: 0.9; pointer-events: none; }
        
        .token { position: absolute; display: flex; justify-content: center; align-items: center; transform: translate(-50%, -50%); pointer-events: auto; }
        .token img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; z-index: 2; }
        .token.selected { outline: 3px solid var(--blue); border-radius: 50%; }
        
        .aura { position: absolute; border-radius: 50%; opacity: 0.4; z-index: 1; display: none; pointer-events: none; }
        .hp-bar { position: absolute; bottom: -12px; width: 100%; height: 6px; background: #000; border: 1px solid #444; border-radius: 3px; display: none; }
        .hp-fill { height: 100%; background: var(--green); }
        .token-name { position: absolute; top: -22px; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.7); color: white; display: none; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .panel { background: #2c3e50; padding: 15px; border-radius: 15px; width: 90%; max-width: 350px; max-height: 85vh; overflow-y: auto; }
        label { font-size: 11px; color: var(--blue); font-weight: bold; }
        input[type="range"] { width: 100%; margin: 5px 0 10px 0; }
    </style>
</head>
<body>

<div id="toolbar">
    <div class="btn-group"><button onclick="UI.toggleLib()" style="background:var(--purple); font-size: 20px;">üìÇ</button></div>
    
    <div class="btn-group">
        <button id="btn-grid-toggle" onclick="App.toggleGrid()" class="active"># GRILLE</button>
        <button onclick="UI.openConfigGlobal()" style="background:var(--orange)">‚öôÔ∏è TAILLE #</button>
    </div>

    <div class="btn-group" style="min-width: 140px;">
        <button id="btn-fog-toggle" onclick="App.toggleFog()" style="width:100%">üåë FOG : OFF</button>
        <div id="fog-tools" style="display:none; gap:2px; width:100%;">
            <button id="btn-brush-reveal" onclick="App.setFogTool('reveal')" class="active" style="flex:1">üîì REVELER</button>
            <button id="btn-brush-hide" onclick="App.setFogTool('hide')" style="flex:1; background:#444">üîí CACHER</button>
        </div>
    </div>

    <div class="btn-group">
        <button onclick="App.fillFog()" style="background:var(--red)">TOUT CACHER</button>
        <button onclick="UI.openDice()" style="background:var(--purple); font-size: 18px;">üé≤</button>
        <div id="dice-res" style="font-size: 20px; color: var(--orange); font-weight: bold;">--</div>
    </div>

    <div class="btn-group" style="border:none;">
        <div style="display:flex; gap:2px; margin-bottom:2px;">
            <button onclick="Data.save()" style="background:var(--green)">üíæ SAVE</button>
            <button onclick="Data.load()" style="background:#f1c40f; color:#000">‚Ü∫ LOAD</button>
        </div>
        <div style="display:flex; gap:2px; width:100%;">
            <button onclick="Data.exportToFile()" style="background:#34495e; flex:1;">EXPORTER</button>
            <button onclick="document.getElementById('inp-import').click()" style="background:#34495e; flex:1;">IMPORTER</button>
        </div>
    </div>
</div>

<div id="game-container">
    <canvas id="map-canvas"></canvas>
    <div id="token-layer"></div>
    <canvas id="fog-canvas"></canvas>
</div>

<div id="pop-pion" class="modal">
    <div class="panel">
        <label>Nom</label><input type="text" id="in-name" oninput="App.updateSelected('name', this.value)" style="width:100%; margin-bottom:10px; padding:8px;">
        <label>PV (0 = cach√©)</label><input type="number" id="in-hp" oninput="App.updateSelected('hp', this.value)" style="width:100%; margin-bottom:10px; padding:8px;">
        <label>Taille Pion</label><input type="range" min="30" max="300" id="in-size" oninput="App.updateSelected('s', this.value)">
        <label>Rotation</label><input type="range" min="0" max="360" id="in-rot" oninput="App.updateSelected('rot', this.value)">
        <label>Aura (Port√©e)</label><input type="range" min="0" max="250" id="in-aura" oninput="App.updateSelected('aura', this.value)">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <button onclick="App.toggleLock()" style="background:var(--orange)">üîí LOCK</button>
            <button onclick="App.toggleMirror()" style="background:var(--blue)">FLIP (Miroir)</button>
            <button onclick="App.deleteSelected()" style="background:var(--red)">SUPPRIMER</button>
            <button onclick="UI.close()" style="background:#555">OK</button>
        </div>
    </div>
</div>

<div id="pop-global" class="modal">
    <div class="panel">
        <h3 style="margin-top:0">R√©glage Grille</h3>
        <label>Taille (pixels)</label>
        <input type="range" min="20" max="200" id="in-grid-size" oninput="App.setGridSize(this.value)">
        <button onclick="UI.close()" style="width:100%; background:var(--green); margin-top:10px; padding:10px;">OK</button>
    </div>
</div>

<div id="pop-dice" class="modal"><div class="panel"><div id="dice-grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"></div><button onclick="UI.close()" style="width:100%; margin-top:15px; background:#555; padding:10px;">X</button></div></div>

<div id="library-panel" style="display:none; position:fixed; bottom:0; left:0; width:100%; height:250px; background:var(--panel); border-top:3px solid var(--purple); z-index:1500; flex-direction:column; padding:10px;">
    <div style="display:flex; gap:10px; margin-bottom:10px;"><button onclick="UI.showTab('pions')" style="flex:1; background:var(--purple)">PIONS</button><button onclick="UI.showTab('maps')" style="flex:1; background:#444">MAPS</button></div>
    <div id="lib-pions"><button onclick="document.getElementById('inp-pion').click()" style="width:100%; background:var(--green); padding:10px;">+ PION</button></div>
    <div id="lib-maps" style="display:none"><div id="map-list" style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;"></div><button onclick="document.getElementById('inp-map').click()" style="width:100%; background:var(--blue); padding:10px;">+ MAP</button></div>
</div>

<input type="file" id="inp-pion" hidden onchange="IO.load(this, 'pion')">
<input type="file" id="inp-map" hidden onchange="IO.load(this, 'map')">
<input type="file" id="inp-import" hidden onchange="Data.importFromFile(this)">

<script>
const State = {
    view: document.getElementById('game-container'),
    layer: document.getElementById('token-layer'),
    mapCnv: document.getElementById('map-canvas'),
    fogCnv: document.getElementById('fog-canvas'),
    mapCtx: null, fogCtx: null, tokens: [], scenes: [], activeScene: -1, selections: [],
    isFogMode: false, fogTool: 'reveal', drag: { active: false, lx: 0, ly: 0, isMap: false },
    gridEnabled: true, gridSize: 50
};

const App = {
    init() {
        State.mapCtx = State.mapCnv.getContext('2d'); State.fogCtx = State.fogCnv.getContext('2d');
        window.addEventListener('resize', App.resize); App.resize();
    },
    resize() {
        State.mapCnv.width = State.fogCnv.width = State.view.offsetWidth;
        State.mapCnv.height = State.fogCnv.height = State.view.offsetHeight;
        App.render();
    },
    render() {
        const ctx = State.mapCtx; ctx.fillStyle = "#000"; ctx.fillRect(0,0,State.mapCnv.width, State.mapCnv.height);
        const s = State.scenes[State.activeScene]; if(!s || !s.img) return;
        ctx.save(); ctx.translate(s.offX, s.offY); ctx.drawImage(s.img, 0, 0, s.w, s.h);
        if(State.gridEnabled) {
            ctx.strokeStyle = "rgba(255,255,255,0.2)";
            for(let x=0; x<=s.w; x+=parseInt(State.gridSize)) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,s.h); ctx.stroke(); }
            for(let y=0; y<=s.h; y+=parseInt(State.gridSize)) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(s.w,y); ctx.stroke(); }
        }
        ctx.restore(); State.layer.style.transform = `translate(${s.offX}px, ${s.offY}px)`;
    },
    toggleGrid() { State.gridEnabled = !State.gridEnabled; document.getElementById('btn-grid-toggle').classList.toggle('active', State.gridEnabled); App.render(); },
    setGridSize(v) { State.gridSize = v; App.render(); },
    toggleFog() {
        State.isFogMode = !State.isFogMode;
        document.getElementById('btn-fog-toggle').innerText = State.isFogMode ? "üåë FOG : ON" : "üåë FOG : OFF";
        document.getElementById('btn-fog-toggle').classList.toggle('active', State.isFogMode);
        document.getElementById('fog-tools').style.display = State.isFogMode ? 'flex' : 'none';
        State.fogCnv.style.pointerEvents = State.isFogMode ? 'auto' : 'none';
    },
    setFogTool(t) {
        State.fogTool = t;
        document.getElementById('btn-brush-reveal').classList.toggle('active', t === 'reveal');
        document.getElementById('btn-brush-hide').classList.toggle('active', t === 'hide');
    },
    fillFog() { State.fogCtx.fillStyle = "black"; State.fogCtx.fillRect(0,0,State.fogCnv.width, State.fogCnv.height); },
    addToken(src, saved = null) {
        const s = State.scenes[State.activeScene];
        const t = saved || { id:Date.now(), x:100-(s?s.offX:0), y:100-(s?s.offY:0), s:75, name:'', src, locked:false, mirror:1, rot:0, hp:0, aura:0 };
        const div = document.createElement('div'); div.className = 'token';
        div.innerHTML = `<div class="aura" style="background:var(--blue)"></div><div class="token-name"></div><img src="${t.src}"><div class="hp-bar"><div class="hp-fill"></div></div>`;
        div.addEventListener('touchstart', (e) => {
            if(State.isFogMode) return; e.stopPropagation();
            if(State.selections.includes(t) && Date.now()-(t.lc||0)<300) UI.openConfig(t);
            t.lc = Date.now(); App.clearSelection(); State.selections = [t]; div.classList.add('selected');
            if(!t.locked) { State.drag.active = true; State.drag.lx = e.touches[0].clientX; State.drag.ly = e.touches[0].clientY; }
        });
        State.layer.appendChild(div); t.el = div; State.tokens.push(t); App.updateVis(t);
    },
    updateVis(t) {
        if(!t.el) return;
        t.el.style.width = t.s + 'px'; t.el.style.height = t.s + 'px'; t.el.style.left = t.x + 'px'; t.el.style.top = t.y + 'px';
        t.el.querySelector('img').style.transform = `scaleX(${t.mirror}) rotate(${t.rot}deg)`;
        const nt = t.el.querySelector('.token-name'); if(t.name){ nt.innerText=t.name; nt.style.display='block';} else nt.style.display='none';
        const a = t.el.querySelector('.aura'); if(t.aura>0){ a.style.display='block'; a.style.width=a.style.height=(parseInt(t.s)+parseInt(t.aura))+'px';} else a.style.display='none';
        const bar = t.el.querySelector('.hp-bar'); if(t.hp>0){ bar.style.display='block'; t.el.querySelector('.hp-fill').style.width=Math.min(t.hp,100)+'%';} else bar.style.display='none';
    },
    toggleLock() { State.selections.forEach(t => t.locked = !t.locked); UI.close(); },
    toggleMirror() { State.selections.forEach(t => { t.mirror *= -1; App.updateVis(t); }); },
    updateSelected(k, v) { State.selections.forEach(t => { t[k] = v; App.updateVis(t); }); },
    clearSelection() { State.selections = []; document.querySelectorAll('.token').forEach(el => el.classList.remove('selected')); },
    deleteSelected() { State.selections.forEach(t => { t.el.remove(); State.tokens = State.tokens.filter(x => x.id !== t.id); }); UI.close(); }
};

State.view.addEventListener('touchstart', (e) => {
    if(e.touches.length === 2) { State.drag.isMap = true; State.drag.lx = (e.touches[0].clientX + e.touches[1].clientX)/2; State.drag.ly = (e.touches[0].clientY + e.touches[1].clientY)/2; }
    else App.clearSelection();
});
State.view.addEventListener('touchmove', (e) => {
    const s = State.scenes[State.activeScene];
    if(State.isFogMode && e.touches.length === 1) {
        const r = State.view.getBoundingClientRect();
        const x = e.touches[0].clientX - r.left; const y = e.touches[0].clientY - r.top;
        State.fogCtx.globalCompositeOperation = (State.fogTool === 'reveal') ? 'destination-out' : 'source-over';
        if(State.fogTool !== 'reveal') State.fogCtx.fillStyle = "black";
        State.fogCtx.beginPath(); State.fogCtx.arc(x, y, 35, 0, Math.PI*2); State.fogCtx.fill();
    } else if(State.drag.active) {
        const dx = e.touches[0].clientX - State.drag.lx; const dy = e.touches[0].clientY - State.drag.ly;
        State.selections.forEach(t => { t.x += dx; t.y += dy; App.updateVis(t); });
        State.drag.lx = e.touches[0].clientX; State.drag.ly = e.touches[0].clientY;
    } else if(State.drag.isMap && s) {
        const mx = (e.touches[0].clientX+e.touches[1].clientX)/2; const my = (e.touches[0].clientY+e.touches[1].clientY)/2;
        s.offX += mx - State.drag.lx; s.offY += my - State.drag.ly; State.drag.lx = mx; State.drag.ly = my; App.render();
    }
}, {passive:false});
State.view.addEventListener('touchend', () => { State.drag.active = false; State.drag.isMap = false; });

const UI = {
    toggleLib: () => { const p = document.getElementById('library-panel'); p.style.display = p.style.display==='none'?'flex':'none'; },
    showTab: (t) => { document.getElementById('lib-pions').style.display = t==='pions'?'block':'none'; document.getElementById('lib-maps').style.display = t==='maps'?'block':'none'; },
    openConfig: (t) => {
        document.getElementById('in-name').value = t.name; document.getElementById('in-hp').value = t.hp;
        document.getElementById('in-size').value = t.s; document.getElementById('in-rot').value = t.rot;
        document.getElementById('in-aura').value = t.aura; document.getElementById('pop-pion').style.display = 'flex';
    },
    openConfigGlobal: () => { document.getElementById('in-grid-size').value = State.gridSize; document.getElementById('pop-global').style.display = 'flex'; },
    updateMapList() {
        const l = document.getElementById('map-list'); l.innerHTML = '';
        State.scenes.forEach((s, i) => {
            const d = document.createElement('div'); d.style.cssText = `width:70px; height:50px; border:2px solid #555; background:url(${s.src}) center/cover; flex-shrink:0; border-radius:5px;`;
            d.onclick = () => { State.activeScene = i; App.render(); UI.toggleLib(); }; l.appendChild(d);
        });
    },
    openDice: () => {
        const g = document.getElementById('dice-grid'); g.innerHTML = '';
        [4,6,8,10,12,20,100].forEach(d => {
            const b = document.createElement('button'); b.innerText = 'D'+d;
            b.onclick = () => { document.getElementById('dice-res').innerText = Math.floor(Math.random()*d)+1; UI.close(); }; g.appendChild(b);
        });
        document.getElementById('pop-dice').style.display = 'flex';
    },
    close: () => document.querySelectorAll('.modal').forEach(m => m.style.display='none')
};

const IO = {
    load(el, type) {
        if(!el.files[0]) return;
        const r = new FileReader();
        r.onload = (e) => {
            if(type==='pion') App.addToken(e.target.result);
            else {
                const i = new Image(); i.onload = () => {
                    const ratio = State.view.offsetWidth / i.width;
                    State.scenes.push({img:i, src:e.target.result, offX:0, offY:0, w:State.view.offsetWidth, h:i.height*ratio});
                    State.activeScene = State.scenes.length-1; UI.updateMapList(); App.render();
                }; i.src = e.target.result;
            }
        }; r.readAsDataURL(el.files[0]);
    }
};

const Data = {
    getPack() {
        return { 
            gridSize: State.gridSize, active: State.activeScene,
            tokens: State.tokens.map(t=>{const c={...t}; delete c.el; return c;}), 
            scenes: State.scenes.map(s=>({src:s.src, offX:s.offX, offY:s.offY, w:s.w, h:s.h})) 
        };
    },
    save() { localStorage.setItem('vtt_v18', JSON.stringify(this.getPack())); alert("Sauv√© !"); },
    load() { const r = localStorage.getItem('vtt_v18'); if(r) this.applyPack(r); },
    
    exportToFile() {
        try {
            const json = JSON.stringify(this.getPack());
            const blob = new Blob([json], {type: 'application/octet-stream'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'ma_partie_vtt.json';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 300);
            alert("V√©rifiez vos t√©l√©chargements !");
        } catch(e) { alert("Erreur d'exportation."); }
    },
    importFromFile(el) {
        const file = el.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = (e) => { 
            try { this.applyPack(e.target.result); alert("Partie import√©e !"); } catch(err) { alert("Fichier invalide."); }
        };
        r.readAsText(file);
    },
    applyPack(raw) {
        const d = JSON.parse(raw); 
        State.gridSize = d.gridSize || 50; State.activeScene = d.active;
        State.tokens.forEach(t => { if(t.el) t.el.remove(); }); 
        State.tokens = [];
        State.scenes = d.scenes.map(s => {
            const i = new Image(); i.onload = () => App.render(); i.src = s.src;
            return {img:i, ...s};
        });
        if(d.tokens) d.tokens.forEach(t => App.addToken(t.src, t));
        UI.updateMapList();
        setTimeout(() => App.render(), 100);
    }
};

// ENREGISTREMENT PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log("PWA Ready"))
    .catch(err => console.log("PWA Error", err));
}

App.init();
</script>
</body>
</html>
